<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PT copy thingy</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    .row { margin-bottom: 1em; }
    textarea { width: 80%; height: 60px; }
    button { padding: 8px 12px; margin-left: 10px; }
    .flash-red { background-color: #f88 !important; }
    .flash-yellow { background-color: #ff8 !important; }
    .flash-green { background-color: #8f8 !important; }
  </style>
</head>
<body>
  <h2>PT copy thingy</h2>
  <div id="container"></div>

  <script>
    const rowCount = 50;
    const rows = [];

    function createRow(index) {
      const div = document.createElement('div');
      div.className = 'row';

      const textarea = document.createElement('textarea');
      textarea.id = `txt${index}`;

      const btnAlpha = document.createElement('button');
      btnAlpha.textContent = 'Alpha';
      btnAlpha.id = `btnAlpha${index}`;

      const btndelta = document.createElement('button');
      btndelta.textContent = 'delta';
      btndelta.id = `btndelta${index}`;

      div.appendChild(textarea);
      div.appendChild(btnAlpha);
      div.appendChild(btndelta);
      document.getElementById('container').appendChild(div);

      const row = {
        index,
        textarea,
        btnAlpha,
        btndelta,
        lastPT: getPT(textarea.value),
        lastClickTime: 0
      };

      btnAlpha.addEventListener('click', () => handleClick(row, 'alpha bravo charlie'));
      btndelta.addEventListener('click', () => handleClick(row, 'delta echo'));

      return row;
    }

    async function handleClick(row, endingPhrase) {
      const now = Date.now();
      if (now - row.lastClickTime < 500) return;
      row.lastClickTime = now;

      const textarea = row.textarea;
      let originalText = textarea.value.trim();
      let text = originalText;

      let clipText = await navigator.clipboard.readText();
      clipText = clipText.trim();
      const words = clipText.split(/\s+/);
      const lastWord = words.at(-1);

      let didPT = false;

      if (/^pt\d+$/i.test(lastWord)) {
        const newText = replacePT(text, lastWord);
        if (newText !== null && getPT(text).toLowerCase() !== lastWord.toLowerCase()) {
          text = newText;
          row.lastPT = lastWord;
          didPT = true;
        }
      }

      // Remove current alpha/delta ending if present
      text = text.replace(/\b(alpha bravo charlie|delta echo)\s*$/i, '').trim();

      // Add new ending
      text += ' ' + endingPhrase;

      textarea.value = text;
      await navigator.clipboard.writeText(text);

      flash(
        endingPhrase === 'alpha bravo charlie' ? row.btnAlpha : row.btndelta,
        didPT ? 'green' : 'yellow'
      );
    }

    function flash(button, color) {
      const cls = `flash-${color}`;
      button.classList.add(cls);
      button.disabled = true;
      setTimeout(() => {
        button.classList.remove(cls);
        button.disabled = false;
      }, 500);
    }

    function getPT(text) {
      const match = text.match(/\bpt\d+\b/i);
      return match ? match[0] : '';
    }

    function replacePT(text, newPT) {
      const match = text.match(/\bpt\d+\b/i);
      if (match) {
        return text.slice(0, match.index) + newPT + text.slice(match.index + match[0].length);
      }
      return null;
    }

    function loadState() {
      for (let i = 1; i <= rowCount; i++) {
        const saved = localStorage.getItem(`row${i}`);
        if (saved) {
          document.getElementById(`txt${i}`).value = saved;
          rows[i - 1].lastPT = getPT(saved);
        }
      }
    }

    window.addEventListener('beforeunload', () => {
      rows.forEach((row, i) => {
        localStorage.setItem(`row${i + 1}`, row.textarea.value);
      });
    });

    for (let i = 1; i <= rowCount; i++) {
      rows.push(createRow(i));
    }

    window.addEventListener('load', loadState);
  </script>
</body>
</html>
`
