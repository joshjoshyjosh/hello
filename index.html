<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PT copy thing</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    .row { margin-bottom: 1em; }
    textarea { width: 80%; height: 60px; }
    button { padding: 8px 12px; margin-left: 10px; }
    .flash-red { background-color: #f88 !important; }
    .flash-yellow { background-color: #ff8 !important; }
    .flash-green { background-color: #8f8 !important; }
  </style>
</head>
<body>
  <h2>PT copy thing</h2>
  <div id="container"></div>

  <script>
    const rowCount = 50;
    const rows = [];

    function createRow(index) {
      const div = document.createElement('div');
      div.className = 'row';

      const textarea = document.createElement('textarea');
      textarea.id = `txt${index}`;

      const btnUseClipboard = document.createElement('button');
      btnUseClipboard.textContent = 'Use Clipboard';
      btnUseClipboard.id = `btnClipboard${index}`;

      const btnCheck = document.createElement('button');
      btnCheck.textContent = 'Check Phrase';
      btnCheck.id = `btnCheck${index}`;

      const btnReplace = document.createElement('button');
      btnReplace.textContent = 'Replace Phrase';
      btnReplace.id = `btnReplace${index}`;

      div.appendChild(textarea);
      div.appendChild(btnUseClipboard);
      div.appendChild(btnCheck);
      div.appendChild(btnReplace);
      document.getElementById('container').appendChild(div);

      const row = {
        index,
        textarea,
        btnUseClipboard,
        btnCheck,
        btnReplace,
        manualEdited: false,
        lastPT: getPT(textarea.value),
        lastClickTime: 0
      };

      textarea.addEventListener('input', () => {
        row.manualEdited = true;
        row.lastPT = getPT(textarea.value);
      });

      btnUseClipboard.addEventListener('click', async () => {
        const now = Date.now();
        if (now - row.lastClickTime < 500) return;
        row.lastClickTime = now;

        const textArea = row.textarea;

        if (row.manualEdited) {
          navigator.clipboard.writeText(textArea.value);
          row.manualEdited = false;
          return;
        }

        let clipText = await navigator.clipboard.readText();
        clipText = clipText.trim();
        const words = clipText.split(/\s+/);
        const lastWord = words.at(-1);

        if (!/^pt\d+$/i.test(lastWord)) {
          navigator.clipboard.writeText(textArea.value);
          flash(btnUseClipboard, 'red');
          return;
        }

        if (row.lastPT.toLowerCase() === lastWord.toLowerCase()) {
          flash(btnUseClipboard, 'yellow');
          return;
        }

        const newText = replacePT(textArea.value, lastWord);
        if (newText !== null) {
          textArea.value = newText;
          navigator.clipboard.writeText(newText);
          row.manualEdited = false;
          row.lastPT = lastWord;
          flash(btnUseClipboard, 'green');
        } else {
          navigator.clipboard.writeText(textArea.value);
          flash(btnUseClipboard, 'red');
        }
      });

      btnCheck.addEventListener('click', () => {
        const txt = row.textarea.value.toLowerCase();
        if (txt.includes('alpha bravo charlie')) {
          flash(btnCheck, 'green');
        } else {
          flash(btnCheck, 'red');
        }
      });

      btnReplace.addEventListener('click', () => {
        const txt = row.textarea.value;
        if (txt.toLowerCase().includes('alpha bravo charlie')) {
          const replaced = txt.replace(/alpha bravo charlie/gi, 'eggshell fortnite');
          row.textarea.value = replaced;
          row.manualEdited = true;
          flash(btnReplace, 'green');
        } else {
          flash(btnReplace, 'red');
        }
      });

      return row;
    }

    function flash(button, color) {
      const cls = `flash-${color}`;
      button.classList.add(cls);
      button.disabled = true;
      setTimeout(() => {
        button.classList.remove(cls);
        button.disabled = false;
      }, 1000);
    }

    function getPT(text) {
      const match = text.match(/\bpt\d+\b/i);
      return match ? match[0] : '';
    }

    function replacePT(text, newPT) {
      const match = text.match(/\bpt\d+\b/i);
      if (match) {
        return text.slice(0, match.index) + newPT + text.slice(match.index + match[0].length);
      }
      return null;
    }

    function loadState() {
      for (let i = 1; i <= rowCount; i++) {
        const saved = localStorage.getItem(`row${i}`);
        if (saved) {
          document.getElementById(`txt${i}`).value = saved;
          rows[i - 1].lastPT = getPT(saved);
        }
      }
    }

    window.addEventListener('beforeunload', () => {
      rows.forEach((row, i) => {
        localStorage.setItem(`row${i + 1}`, row.textarea.value);
      });
    });

    for (let i = 1; i <= rowCount; i++) {
      rows.push(createRow(i));
    }

    window.addEventListener('load', loadState);
  </script>
</body>
</html>
