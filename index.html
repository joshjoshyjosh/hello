<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>ThingyThings</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .row {
            margin-bottom: 1em;
        }
        textarea {
            width: 80%;
            height: 60px;
            vertical-align: top;
        }
        button {
            padding: 6px 10px;
            margin-left: 10px;
            vertical-align: top;
        }
        .flash-red { background-color: #f88 !important; }
        .flash-yellow { background-color: #ff8 !important; }
        .flash-green { background-color: #8f8 !important; }
        .flash-blue { background-color: #88f !important; }
        #topButtons { margin-bottom: 15px; }
        .editable-label {
            display: block;
            margin-bottom: 3px;
            border: 1px solid transparent;
            padding: 2px;
            cursor: pointer;
        }
        .editable-label:hover { background-color: #e9e9e9; }
        .editable-label:focus { outline: 1px solid #007bff; background-color: #fff; }
    </style>
</head>
<body>
    <div id="topButtons">
        <button id="btnMain">PT Tool</button>
        <button id="btnAlt">Other Thing</button>
        <button id="btnNotes">Notes</button>
        <button id="btnDownload">Download All</button>
        <button id="btnUpload">Upload All</button>
        <input type="file" id="fileInput" style="display:none"/>
    </div>

    <div id="mainView"></div>
    <div id="altView" style="display:none"></div>
    <div id="notesView" style="display:none"></div>

    <script>
        const ptRowCount = 50;
        const phoneRowCount = 5;
        const notesRowCount = 50;

        const btnMain = document.getElementById('btnMain');
        const btnAlt = document.getElementById('btnAlt');
        const btnNotes = document.getElementById('btnNotes');
        const btnDownload = document.getElementById('btnDownload');
        const btnUpload = document.getElementById('btnUpload');
        const fileInput = document.getElementById('fileInput');

        const mainView = document.getElementById('mainView');
        const altView = document.getElementById('altView');
        const notesView = document.getElementById('notesView');

        const mainKeyPrefix = 'main_row_';
        const altKeyPrefix = 'alt_row_';
        const notesKeyPrefix = 'notes_row_';

        const mainLabelKeyPrefix = 'main_label_';
        const altLabelKeyPrefix = 'alt_label_';
        const notesLabelKeyPrefix = 'notes_label_';

        // --- View Switching ---
        btnMain.addEventListener('click', () => {
            mainView.style.display = '';
            altView.style.display = 'none';
            notesView.style.display = 'none';
            btnMain.disabled = true;
            btnAlt.disabled = false;
            btnNotes.disabled = false;
        });
        btnAlt.addEventListener('click', () => {
            mainView.style.display = 'none';
            altView.style.display = '';
            notesView.style.display = 'none';
            btnMain.disabled = false;
            btnAlt.disabled = true;
            btnNotes.disabled = false;
        });
        btnNotes.addEventListener('click', () => {
            mainView.style.display = 'none';
            altView.style.display = 'none';
            notesView.style.display = '';
            btnMain.disabled = false;
            btnAlt.disabled = false;
            btnNotes.disabled = true;
        });
        btnMain.disabled = true;

        // --- Flash Helper ---
        function flash(button, color) {
            const cls = `flash-${color}`;
            button.classList.add(cls);
            button.disabled = true;
            setTimeout(() => {
                button.classList.remove(cls);
                button.disabled = false;
            }, 800);
        }

        // --- PT Tool Functions ---
        function createPTrow(index, container, pagePrefix, labelPrefix) {
            const div = document.createElement('div');
            div.className = 'row';

            const label = document.createElement('span');
            label.className = 'editable-label';
            label.contentEditable = true;
            label.textContent = localStorage.getItem(`${labelPrefix}${index}`) || `PT Row ${index}`;
            label.addEventListener('blur', () => localStorage.setItem(`${labelPrefix}${index}`, label.textContent));
            div.appendChild(label);

            const textarea = document.createElement('textarea');
            textarea.id = `${pagePrefix}txt${index}`;
            textarea.value = localStorage.getItem(`${pagePrefix}${index}`) || '';
            textarea.addEventListener('input', () => localStorage.setItem(`${pagePrefix}${index}`, textarea.value));
            div.appendChild(textarea);

            const btnSPC = document.createElement('button');
            btnSPC.textContent = 'SPC';
            btnSPC.addEventListener('click', () => handlePTButtonClick(textarea, btnSPC, 'Southern Phone Team', `${pagePrefix}${index}`));
            div.appendChild(btnSPC);

            const btnAGL = document.createElement('button');
            btnAGL.textContent = 'AGL';
            btnAGL.addEventListener('click', () => handlePTButtonClick(textarea, btnAGL, 'AGL Team', `${pagePrefix}${index}`));
            div.appendChild(btnAGL);

            container.appendChild(div);
        }

        async function handlePTButtonClick(textarea, clickedButton, endingPhrase, storageKey) {
            try {
                let text = textarea.value;
                let clipText = (await navigator.clipboard.readText()).trim();

                const isValidPT = /^pt\d+$/i.test(clipText);
                const formattedPT = isValidPT ? 'PT' + clipText.match(/\d+/)[0] : null;

                const currentPTMatch = text.match(/\bpt\d+\b/i);
                const currentPT = currentPTMatch ? currentPTMatch[0].toUpperCase() : null;

                let ptChanged = false;

                // ✅ Replace PT ONLY if a new valid PT is provided and it's different
                if (isValidPT && (!currentPT || currentPT !== formattedPT)) {
                    if (currentPTMatch) {
                        text = text.replace(currentPTMatch[0], formattedPT);
                    }
                    ptChanged = true;
                }

                // ✅ ALWAYS replace the team in-place, regardless of PT
                text = text.replace(
                    /\b(Southern Phone Team|AGL Team)\b/gi,
                    endingPhrase
                );

                textarea.value = text;
                localStorage.setItem(storageKey, text);
                await navigator.clipboard.writeText(text);

                // ✅ Feedback color
                if (ptChanged) {
                    flash(clickedButton, 'green');
                } else {
                    flash(clickedButton, 'blue'); // team-only change
                }

            } catch (e) {
                console.error(e);
                flash(clickedButton, 'red');
            }
        }


        // --- Notes Tool Functions ---
        function createNotesrow(index, container, pagePrefix, labelPrefix) {
            const div = document.createElement('div');
            div.className = 'row';

            const label = document.createElement('span');
            label.className = 'editable-label';
            label.contentEditable = true;
            label.textContent = localStorage.getItem(`${labelPrefix}${index}`) || `Notes Row ${index}`;
            label.addEventListener('blur', () => localStorage.setItem(`${labelPrefix}${index}`, label.textContent));
            div.appendChild(label);

            const textarea = document.createElement('textarea');
            textarea.id = `${pagePrefix}txt${index}`;
            textarea.value = localStorage.getItem(`${pagePrefix}${index}`) || '';
            textarea.addEventListener('input', () => localStorage.setItem(`${pagePrefix}${index}`, textarea.value));
            div.appendChild(textarea);

            const btnIn = document.createElement('button');
            btnIn.textContent = 'Inbound';
            btnIn.addEventListener('click', () => handleNotesButtonClick(textarea, btnIn, 'Inbound', `${pagePrefix}${index}`));
            div.appendChild(btnIn);

            const btnOut = document.createElement('button');
            btnOut.textContent = 'Outbound';
            btnOut.addEventListener('click', () => handleNotesButtonClick(textarea, btnOut, 'Outbound', `${pagePrefix}${index}`));
            div.appendChild(btnOut);

            container.appendChild(div);
        }

        async function handleNotesButtonClick(textarea, clickedButton, newText, storageKey) {
            try {
                let text = textarea.value;
                const oldText = newText === 'Outbound' ? 'Inbound' : 'Outbound';
                const regex = new RegExp(`\\b${oldText}\\b`, 'gi');
                const newContent = text.replace(regex, newText);

                if (newContent === text) {
                    await navigator.clipboard.writeText(text);
                    flash(clickedButton, 'blue');
                } else {
                    textarea.value = newContent;
                    localStorage.setItem(storageKey, newContent);
                    await navigator.clipboard.writeText(newContent);
                    flash(clickedButton, 'green');
                }
            } catch (e) {
                console.error(e);
                flash(clickedButton, 'red');
            }
        }

        // --- Phone Number Tool ---
        function createPhoneRow(index, container) {
            const div = document.createElement('div');
            div.className = 'row';

            const label = document.createElement('label');
            label.textContent = `Row ${index}`;
            label.style.display = 'block';
            label.style.marginBottom = '3px';
            div.appendChild(label);

            const textarea = document.createElement('textarea');
            textarea.id = `${altKeyPrefix}txt${index}`;
            textarea.value = localStorage.getItem(`${altKeyPrefix}${index}`) || '';
            textarea.addEventListener('input', () => localStorage.setItem(`${altKeyPrefix}${index}`, textarea.value));
            div.appendChild(textarea);

            const btnCopy = document.createElement('button');
            btnCopy.textContent = 'Copy';
            btnCopy.addEventListener('click', async () => {
                await navigator.clipboard.writeText(textarea.value);
                flash(btnCopy, 'green');
            });
            div.appendChild(btnCopy);

            const btnAppend = document.createElement('button');
            btnAppend.textContent = 'Append';
            btnAppend.addEventListener('click', async () => {
                let clip = await navigator.clipboard.readText();
                let amendedText = textarea.value.substring(textarea.value.indexOf('\n') + 1);
                await navigator.clipboard.writeText(`${clip.trim()}\n${amendedText.trim()}`);
                flash(btnAppend, 'green');
            });
            div.appendChild(btnAppend);

            container.appendChild(div);
        }

        // --- Initialize Rows ---
        for (let i = 1; i <= ptRowCount; i++) createPTrow(i, mainView, mainKeyPrefix, mainLabelKeyPrefix);
        for (let i = 1; i <= phoneRowCount; i++) createPhoneRow(i, altView);
        for (let i = 1; i <= notesRowCount; i++) createNotesrow(i, notesView, notesKeyPrefix, notesLabelKeyPrefix);

        // --- Download & Upload ---
        btnDownload.addEventListener('click', () => {
            const allData = {};
            for (let i = 1; i <= ptRowCount; i++) {
                allData[`${mainKeyPrefix}${i}`] = localStorage.getItem(`${mainKeyPrefix}${i}`) || '';
                allData[`${mainLabelKeyPrefix}${i}`] = localStorage.getItem(`${mainLabelKeyPrefix}${i}`) || '';
            }
            for (let i = 1; i <= phoneRowCount; i++) {
                allData[`${altKeyPrefix}${i}`] = localStorage.getItem(`${altKeyPrefix}${i}`) || '';
            }
            for (let i = 1; i <= notesRowCount; i++) {
                allData[`${notesKeyPrefix}${i}`] = localStorage.getItem(`${notesKeyPrefix}${i}`) || '';
                allData[`${notesLabelKeyPrefix}${i}`] = localStorage.getItem(`${notesLabelKeyPrefix}${i}`) || '';
            }

            const blob = new Blob([JSON.stringify(allData)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'thingythings_backup.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        btnUpload.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                    location.reload();
                } catch (err) {
                    alert('Invalid JSON file');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>
